var _interopRequireWildcard=require("@babel/runtime/helpers/interopRequireWildcard");var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");var _defineProperty2=_interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));var _regenerator=_interopRequireDefault(require("@babel/runtime/regenerator"));var path=_interopRequireWildcard(require("path"));var cp=_interopRequireWildcard(require("child_process"));var _express=_interopRequireDefault(require("express"));var _cors=_interopRequireDefault(require("cors"));var _bcryptjs=_interopRequireDefault(require("bcryptjs"));var _bodyParser=_interopRequireDefault(require("body-parser"));var _FolderSongs=_interopRequireDefault(require("../../src/FolderSongs"));var _FolderExtras=_interopRequireDefault(require("../../src/FolderExtras"));var _lowdb=_interopRequireDefault(require("lowdb"));var _FileSync=_interopRequireDefault(require("lowdb/adapters/FileSync"));var _jsonwebtoken=_interopRequireDefault(require("jsonwebtoken"));var _gmailSend=_interopRequireDefault(require("gmail-send"));var _cryptoRandomString=_interopRequireDefault(require("crypto-random-string"));var _chokidar=_interopRequireDefault(require("chokidar"));if(!process.env.NODE_ENV){throw new Error('Establecer un valor para NODE_ENV');}if(!process.env.PORT){throw new Error('Establecer un valor para PORT');}var mailSender=(0,_gmailSend.default)({user:'javier.alejandro.castro@gmail.com',pass:process.env.GMAIL_PASSWORD,subject:'iResucito Web'});var merge=require('deepmerge');var dataPath=path.resolve(process.cwd(),'../data');var syncScriptPath=path.resolve(process.cwd(),'../server');_FolderSongs.default.basePath=path.resolve(process.cwd(),'../../songs');_FolderExtras.default.basePath=dataPath;var adapter=new _FileSync.default(path.join(dataPath,'db.json'));var db=(0,_lowdb.default)(adapter);db.defaults({users:[],tokens:[]}).write();var watcher=_chokidar.default.watch(dataPath,{persistent:true,ignoreInitial:true});watcher.on('add',function(path){cp.spawn('node',['./syncData.js','up',path],{cwd:syncScriptPath});}).on('change',function(path){cp.spawn('node',['./syncData.js','up',path],{cwd:syncScriptPath});});function readLocalePatch(){var exists,patchJSON;return _regenerator.default.async(function readLocalePatch$(_context){while(1){switch(_context.prev=_context.next){case 0:_context.next=2;return _regenerator.default.awrap(_FolderExtras.default.patchExists());case 2:exists=_context.sent;if(!exists){_context.next=8;break;}_context.next=6;return _regenerator.default.awrap(_FolderExtras.default.readPatch());case 6:patchJSON=_context.sent;return _context.abrupt("return",JSON.parse(patchJSON));case 8:case"end":return _context.stop();}}});}function saveLocalePatch(patchObj){var json;return _regenerator.default.async(function saveLocalePatch$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:json=JSON.stringify(patchObj,null,' ');_context2.next=3;return _regenerator.default.awrap(_FolderExtras.default.savePatch(json));case 3:case"end":return _context2.stop();}}});}var server=(0,_express.default)();server.use(_bodyParser.default.json());server.use((0,_cors.default)());var webClientFolder=path.resolve('../dist');server.use(_express.default.static(webClientFolder));server.get('/',function(req,res){res.sendFile(path.join(webClientFolder,'index.html'));});var jwtSecretKey='mysuperSecretKEY';var domain='http://iresucito.herokuapp.com';server.use(function _callee(req,res,next){var authorization,token,payload,user;return _regenerator.default.async(function _callee$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:authorization=req.headers.authorization;if(!authorization){_context3.next=13;break;}_context3.prev=2;token=authorization.split(' ')[1];_context3.next=6;return _regenerator.default.awrap(_jsonwebtoken.default.verify(token,jwtSecretKey));case 6:payload=_context3.sent;if(payload){user=db.get('users').find({email:payload.email}).value();req.user=user;}_context3.next=13;break;case 10:_context3.prev=10;_context3.t0=_context3["catch"](2);console.log(_context3.t0);case 13:next();case 14:case"end":return _context3.stop();}}},null,null,[[2,10]]);});server.post('/api/signup',function(req,res){var _req$body=req.body,email=_req$body.email,password=_req$body.password;if(!email||!password){return res.status(500).json({error:'Provide an email and password to register'});}var exists=db.get('users').find({email:email}).value();if(exists){return res.status(500).json({error:"Email "+email+" already registered!"});}try{var hash=_bcryptjs.default.hashSync(password,_bcryptjs.default.genSaltSync(10));db.get('users').push({email:email,password:hash,isVerified:false}).write();var token=(0,_cryptoRandomString.default)({length:20,type:'url-safe'});db.get('tokens').push({email:email,token:token}).write();mailSender({to:email,text:"Navigate this link "+domain+"/api/verify/"+token+"/"+email+" to activate your account."},function(err,res){console.log({mailSend:{err:err,res:res}});});return res.status(200).json({ok:"User registered. \nOpen your inbox and activate your account \nwith the email we've just sent to you!"});}catch(err){console.log({err:err});return res.status(500).json({error:err});}});server.get('/api/verify/:token/:email',function(req,res){var _req$params=req.params,token=_req$params.token,email=_req$params.email;var user=db.get('users').find({email:email}).value();if(user){if(user.isVerified){return res.status(202).json({ok:'Email Already Verified'});}else{var foundToken=db.get('tokens').find({email:email,token:token}).value();if(foundToken){db.get('users').find({email:email}).assign({isVerified:true}).write();db.get('tokens').remove({email:email,token:token}).write();return res.redirect(301,domain+"?u="+email+"&verified=1");}else{return res.status(404).json({error:'Token expired'});}}}else{return res.status(404).json({error:'Email not found'});}});server.post('/api/login',function(req,res){var _req$body2=req.body,email=_req$body2.email,password=_req$body2.password;var user=db.get('users').find({email:email}).value();if(user){if(!user.isVerified){return res.status(401).json({error:'Unauthorized access. Account was not verified.'});}try{var result=_bcryptjs.default.compareSync(password,user.password);if(result){var JWTToken=_jsonwebtoken.default.sign({email:user.email},jwtSecretKey,{expiresIn:'2h'});return res.status(200).json({jwt:JWTToken});}return res.status(401).json({error:'Unauthorized access'});}catch(err){res.status(401).json({error:'Unauthorized access'});}}else{res.status(500).json({error:'User or password wrong'});}});server.use(function(req,res,next){if(req.user){next();}else{res.status(500).json({error:'Unauthorized access'});}});server.get('/api/list/:locale',function _callee2(req,res){var patch,locale,songs;return _regenerator.default.async(function _callee2$(_context4){while(1){switch(_context4.prev=_context4.next){case 0:_context4.next=2;return _regenerator.default.awrap(readLocalePatch());case 2:patch=_context4.sent;locale=req.params.locale;songs=_FolderSongs.default.getSongsMeta(locale,patch);res.json(songs);case 6:case"end":return _context4.stop();}}});});server.get('/api/song/:key/:locale',function _callee3(req,res){var patch,_req$params2,key,locale,songs,song;return _regenerator.default.async(function _callee3$(_context5){while(1){switch(_context5.prev=_context5.next){case 0:_context5.next=2;return _regenerator.default.awrap(readLocalePatch());case 2:patch=_context5.sent;_req$params2=req.params,key=_req$params2.key,locale=_req$params2.locale;songs=_FolderSongs.default.getSongsMeta(locale,patch);song=songs.find(function(s){return s.key===key;});if(!song){_context5.next=10;break;}_context5.next=9;return _regenerator.default.awrap(_FolderSongs.default.loadSingleSong(locale,song,patch));case 9:res.json(song);case 10:case"end":return _context5.stop();}}});});server.delete('/api/song/:key/:locale',function _callee4(req,res){var patchObj,_req$params3,key,locale;return _regenerator.default.async(function _callee4$(_context6){while(1){switch(_context6.prev=_context6.next){case 0:_context6.next=2;return _regenerator.default.awrap(readLocalePatch());case 2:patchObj=_context6.sent;_req$params3=req.params,key=_req$params3.key,locale=_req$params3.locale;if(!patchObj)patchObj={};delete patchObj[key][locale];_context6.next=8;return _regenerator.default.awrap(saveLocalePatch(patchObj));case 8:console.log('Borrado patch',key);res.json({ok:true});case 10:case"end":return _context6.stop();}}});});server.post('/api/song/:key/:locale',function _callee5(req,res){var patchObj,_req$params4,key,locale,patch,localePatch,updatedPatch;return _regenerator.default.async(function _callee5$(_context7){while(1){switch(_context7.prev=_context7.next){case 0:_context7.next=2;return _regenerator.default.awrap(readLocalePatch());case 2:patchObj=_context7.sent;_req$params4=req.params,key=_req$params4.key,locale=_req$params4.locale;patch=req.body;if(!patchObj)patchObj={};if(patch.rename){patch.rename=patch.rename.trim();}patch.author=req.user.email;localePatch=(0,_defineProperty2.default)({},locale,patch);if(!patchObj[key]){patchObj[key]={};}updatedPatch=merge(patchObj[key],localePatch);patchObj[key]=updatedPatch;_context7.next=14;return _regenerator.default.awrap(saveLocalePatch(patchObj));case 14:console.log('Guardado patch',key,updatedPatch);res.json({ok:true});case 16:case"end":return _context7.stop();}}});});require('http').createServer(server).listen(process.env.PORT,function(){console.log('Http on port',process.env.PORT);});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NlcnZlci9pbmRleC5qcyJdLCJuYW1lcyI6WyJwcm9jZXNzIiwiZW52IiwiTk9ERV9FTlYiLCJFcnJvciIsIlBPUlQiLCJtYWlsU2VuZGVyIiwidXNlciIsInBhc3MiLCJHTUFJTF9QQVNTV09SRCIsInN1YmplY3QiLCJtZXJnZSIsInJlcXVpcmUiLCJkYXRhUGF0aCIsInBhdGgiLCJyZXNvbHZlIiwiY3dkIiwic3luY1NjcmlwdFBhdGgiLCJGb2xkZXJTb25ncyIsImJhc2VQYXRoIiwiRm9sZGVyRXh0cmFzIiwiYWRhcHRlciIsIkZpbGVTeW5jIiwiam9pbiIsImRiIiwiZGVmYXVsdHMiLCJ1c2VycyIsInRva2VucyIsIndyaXRlIiwid2F0Y2hlciIsImNob2tpZGFyIiwid2F0Y2giLCJwZXJzaXN0ZW50IiwiaWdub3JlSW5pdGlhbCIsIm9uIiwiY3AiLCJzcGF3biIsInJlYWRMb2NhbGVQYXRjaCIsInBhdGNoRXhpc3RzIiwiZXhpc3RzIiwicmVhZFBhdGNoIiwicGF0Y2hKU09OIiwiSlNPTiIsInBhcnNlIiwic2F2ZUxvY2FsZVBhdGNoIiwicGF0Y2hPYmoiLCJqc29uIiwic3RyaW5naWZ5Iiwic2F2ZVBhdGNoIiwic2VydmVyIiwidXNlIiwiYm9keVBhcnNlciIsIndlYkNsaWVudEZvbGRlciIsImV4cHJlc3MiLCJzdGF0aWMiLCJnZXQiLCJyZXEiLCJyZXMiLCJzZW5kRmlsZSIsImp3dFNlY3JldEtleSIsImRvbWFpbiIsIm5leHQiLCJhdXRob3JpemF0aW9uIiwiaGVhZGVycyIsInRva2VuIiwic3BsaXQiLCJqd3QiLCJ2ZXJpZnkiLCJwYXlsb2FkIiwiZmluZCIsImVtYWlsIiwidmFsdWUiLCJjb25zb2xlIiwibG9nIiwicG9zdCIsImJvZHkiLCJwYXNzd29yZCIsInN0YXR1cyIsImVycm9yIiwiaGFzaCIsImJjcnlwdCIsImhhc2hTeW5jIiwiZ2VuU2FsdFN5bmMiLCJwdXNoIiwiaXNWZXJpZmllZCIsImxlbmd0aCIsInR5cGUiLCJ0byIsInRleHQiLCJlcnIiLCJtYWlsU2VuZCIsIm9rIiwicGFyYW1zIiwiZm91bmRUb2tlbiIsImFzc2lnbiIsInJlbW92ZSIsInJlZGlyZWN0IiwicmVzdWx0IiwiY29tcGFyZVN5bmMiLCJKV1RUb2tlbiIsInNpZ24iLCJleHBpcmVzSW4iLCJwYXRjaCIsImxvY2FsZSIsInNvbmdzIiwiZ2V0U29uZ3NNZXRhIiwia2V5Iiwic29uZyIsInMiLCJsb2FkU2luZ2xlU29uZyIsImRlbGV0ZSIsInJlbmFtZSIsInRyaW0iLCJhdXRob3IiLCJsb2NhbGVQYXRjaCIsInVwZGF0ZWRQYXRjaCIsImNyZWF0ZVNlcnZlciIsImxpc3RlbiJdLCJtYXBwaW5ncyI6InFWQVNBLGtEQUNBLHlEQUNBLHdEQUNBLGtEQUNBLDBEQUNBLCtEQUNBLDBFQUNBLDRFQUNBLG9EQUNBLHlFQUNBLGtFQUNBLDZEQUNBLGdGQUNBLDBEQXJCQSxHQUFJLENBQUNBLE9BQU8sQ0FBQ0MsR0FBUixDQUFZQyxRQUFqQixDQUEyQixDQUN6QixLQUFNLElBQUlDLENBQUFBLEtBQUosQ0FBVSxtQ0FBVixDQUFOLENBQ0QsQ0FFRCxHQUFJLENBQUNILE9BQU8sQ0FBQ0MsR0FBUixDQUFZRyxJQUFqQixDQUF1QixDQUNyQixLQUFNLElBQUlELENBQUFBLEtBQUosQ0FBVSwrQkFBVixDQUFOLENBQ0QsQ0FpQkQsR0FBTUUsQ0FBQUEsVUFBVSxDQUFHLHVCQUFLLENBQ3RCQyxJQUFJLENBQUUsbUNBRGdCLENBRXRCQyxJQUFJLENBQUVQLE9BQU8sQ0FBQ0MsR0FBUixDQUFZTyxjQUZJLENBR3RCQyxPQUFPLENBQUUsZUFIYSxDQUFMLENBQW5CLENBTUEsR0FBTUMsQ0FBQUEsS0FBSyxDQUFHQyxPQUFPLENBQUMsV0FBRCxDQUFyQixDQUVBLEdBQU1DLENBQUFBLFFBQVEsQ0FBR0MsSUFBSSxDQUFDQyxPQUFMLENBQWFkLE9BQU8sQ0FBQ2UsR0FBUixFQUFiLENBQTRCLFNBQTVCLENBQWpCLENBQ0EsR0FBTUMsQ0FBQUEsY0FBYyxDQUFHSCxJQUFJLENB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QUNYLElBQUosQ0FBUyxDQUFFNkMsRUFBRSxDQUFFLElBQU4sQ0FBVCxFQXhCb0MsZ0RBQXRDLEVBNEJBL0UsT0FBTyxDQUFDLE1BQUQsQ0FBUCxDQUNHd0csWUFESCxDQUNnQm5FLE1BRGhCLEVBRUdvRSxNQUZILENBRVVwSCxPQUFPLENBQUNDLEdBQVIsQ0FBWUcsSUFGdEIsQ0FFNEIsVUFBVyxDQUNuQ21FLE9BQU8sQ0FBQ0MsR0FBUixDQUFZLGNBQVosQ0FBNEJ4RSxPQUFPLENBQUNDLEdBQVIsQ0FBWUcsSUFBeEMsRUFDRCxDQUpIIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQGZsb3dcbmlmICghcHJvY2Vzcy5lbnYuTk9ERV9FTlYpIHtcbiAgdGhyb3cgbmV3IEVycm9yKCdFc3RhYmxlY2VyIHVuIHZhbG9yIHBhcmEgTk9ERV9FTlYnKTtcbn1cblxuaWYgKCFwcm9jZXNzLmVudi5QT1JUKSB7XG4gIHRocm93IG5ldyBFcnJvcignRXN0YWJsZWNlciB1biB2YWxvciBwYXJhIFBPUlQnKTtcbn1cblxuaW1wb3J0ICogYXMgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCAqIGFzIGNwIGZyb20gJ2NoaWxkX3Byb2Nlc3MnO1xuaW1wb3J0IGV4cHJlc3MgZnJvbSAnZXhwcmVzcyc7XG5pbXBvcnQgY29ycyBmcm9tICdjb3JzJztcbmltcG9ydCBiY3J5cHQgZnJvbSAnYmNyeXB0anMnO1xuaW1wb3J0IGJvZHlQYXJzZXIgZnJvbSAnYm9keS1wYXJzZXInO1xuaW1wb3J0IEZvbGRlclNvbmdzIGZyb20gJy4uLy4uL3NyYy9Gb2xkZXJTb25ncyc7XG5pbXBvcnQgRm9sZGVyRXh0cmFzIGZyb20gJy4uLy4uL3NyYy9Gb2xkZXJFeHRyYXMnO1xuaW1wb3J0IGxvdyBmcm9tICdsb3dkYic7XG5pbXBvcnQgRmlsZVN5bmMgZnJvbSAnbG93ZGIvYWRhcHRlcnMvRmlsZVN5bmMnO1xuaW1wb3J0IGp3dCBmcm9tICdqc29ud2VidG9rZW4nO1xuaW1wb3J0IHNlbmQgZnJvbSAnZ21haWwtc2VuZCc7XG5pbXBvcnQgY3J5cHRvIGZyb20gJ2NyeXB0by1yYW5kb20tc3RyaW5nJztcbmltcG9ydCBjaG9raWRhciBmcm9tICdjaG9raWRhcic7XG5cbmNvbnN0IG1haWxTZW5kZXIgPSBzZW5kKHtcbiAgdXNlcjogJ2phdmllci5hbGVqYW5kcm8uY2FzdHJvQGdtYWlsLmNvbScsXG4gIHBhc3M6IHByb2Nlc3MuZW52LkdNQUlMX1BBU1NXT1JELFxuICBzdWJqZWN0OiAnaVJlc3VjaXRvIFdlYidcbn0pO1xuXG5jb25zdCBtZXJnZSA9IHJlcXVpcmUoJ2RlZXBtZXJnZScpO1xuXG5jb25zdCBkYXRhUGF0aCA9IHBhdGgucmVzb2x2ZShwcm9jZXNzLmN3ZCgpLCAnLi4vZGF0YScpO1xuY29uc3Qgc3luY1NjcmlwdFBhdGggPSBwYXRoLnJlc29sdmUocHJvY2Vzcy5jd2QoKSwgJy4uL3NlcnZlcicpO1xuXG5Gb2xkZXJTb25ncy5iYXNlUGF0aCA9IHBhdGgucmVzb2x2ZShwcm9jZXNzLmN3ZCgpLCAnLi4vLi4vc29uZ3MnKTtcbkZvbGRlckV4dHJhcy5iYXNlUGF0aCA9IGRhdGFQYXRoO1xuXG5jb25zdCBhZGFwdGVyID0gbmV3IEZpbGVTeW5jKHBhdGguam9pbihkYXRhUGF0aCwgJ2RiLmpzb24nKSk7XG5jb25zdCBkYiA9IGxvdyhhZGFwdGVyKTtcblxuZGIuZGVmYXVsdHMoeyB1c2VyczogW10sIHRva2VuczogW10gfSkud3JpdGUoKTtcblxuY29uc3Qgd2F0Y2hlciA9IGNob2tpZGFyLndhdGNoKGRhdGFQYXRoLCB7XG4gIHBlcnNpc3RlbnQ6IHRydWUsXG4gIGlnbm9yZUluaXRpYWw6IHRydWVcbn0pO1xuXG53YXRjaGVyXG4gIC5vbignYWRkJywgcGF0aCA9PiB7XG4gICAgY3Auc3Bhd24oJ25vZGUnLCBbJy4vc3luY0RhdGEuanMnLCAndXAnLCBwYXRoXSwge1xuICAgICAgY3dkOiBzeW5jU2NyaXB0UGF0aFxuICAgIH0pO1xuICB9KVxuICAub24oJ2NoYW5nZScsIHBhdGggPT4ge1xuICAgIGNwLnNwYXduKCdub2RlJywgWycuL3N5bmNEYXRhLmpzJywgJ3VwJywgcGF0aF0sIHtcbiAgICAgIGN3ZDogc3luY1NjcmlwdFBhdGhcbiAgICB9KTtcbiAgfSk7XG5cbmFzeW5jIGZ1bmN0aW9uIHJlYWRMb2NhbGVQYXRjaCgpOiA/U29uZ0luZGV4UGF0Y2gge1xuICBjb25zdCBleGlzdHMgPSBhd2FpdCBGb2xkZXJFeHRyYXMucGF0Y2hFeGlzdHMoKTtcbiAgaWYgKGV4aXN0cykge1xuICAgIGNvbnN0IHBhdGNoSlNPTiA9IGF3YWl0IEZvbGRlckV4dHJhcy5yZWFkUGF0Y2goKTtcbiAgICByZXR1cm4gSlNPTi5wYXJzZShwYXRjaEpTT04pO1xuICB9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHNhdmVMb2NhbGVQYXRjaChwYXRjaE9iajogP1NvbmdJbmRleFBhdGNoKSB7XG4gIHZhciBqc29uID0gSlNPTi5zdHJpbmdpZnkocGF0Y2hPYmosIG51bGwsICcgJyk7XG4gIGF3YWl0IEZvbGRlckV4dHJhcy5zYXZlUGF0Y2goanNvbik7XG59XG5cbi8vIEFwcCBwcmluY2lwYWxcbnZhciBzZXJ2ZXIgPSBleHByZXNzKCk7XG5zZXJ2ZXIudXNlKGJvZHlQYXJzZXIuanNvbigpKTtcbnNlcnZlci51c2UoY29ycygpKTtcblxuLy8gUmVjdXJzb3MgZXN0YXRpY29zLCBpbmRleC5odG1sXG5jb25zdCB3ZWJDbGllbnRGb2xkZXIgPSBwYXRoLnJlc29sdmUoJy4uL2Rpc3QnKTtcbnNlcnZlci51c2UoZXhwcmVzcy5zdGF0aWMod2ViQ2xpZW50Rm9sZGVyKSk7XG5zZXJ2ZXIuZ2V0KCcvJywgKHJlcSwgcmVzKSA9PiB7XG4gIHJlcy5zZW5kRmlsZShwYXRoLmpvaW4od2ViQ2xpZW50Rm9sZGVyLCAnaW5kZXguaHRtbCcpKTtcbn0pO1xuXG5jb25zdCBqd3RTZWNyZXRLZXkgPSAnbXlzdXBlclNlY3JldEtFWSc7XG5jb25zdCBkb21haW4gPSAnaHR0cDovL2lyZXN1Y2l0by5oZXJva3VhcHAuY29tJztcblxuLy8gQXV0aFxuc2VydmVyLnVzZShhc3luYyAocmVxLCByZXMsIG5leHQpID0+IHtcbiAgY29uc3QgeyBhdXRob3JpemF0aW9uIH0gPSByZXEuaGVhZGVycztcbiAgaWYgKGF1dGhvcml6YXRpb24pIHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgdG9rZW4gPSBhdXRob3JpemF0aW9uLnNwbGl0KCcgJylbMV07XG4gICAgICBjb25zdCBwYXlsb2FkID0gYXdhaXQgand0LnZlcmlmeSh0b2tlbiwgand0U2VjcmV0S2V5KTtcbiAgICAgIGlmIChwYXlsb2FkKSB7XG4gICAgICAgIGNvbnN0IHVzZXIgPSBkYlxuICAgICAgICAgIC5nZXQoJ3VzZXJzJylcbiAgICAgICAgICAuZmluZCh7IGVtYWlsOiBwYXlsb2FkLmVtYWlsIH0pXG4gICAgICAgICAgLnZhbHVlKCk7XG4gICAgICAgIHJlcS51c2VyID0gdXNlcjtcbiAgICAgIH1cbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICBjb25zb2xlLmxvZyhlKTtcbiAgICB9XG4gIH1cbiAgbmV4dCgpO1xufSk7XG5cbnNlcnZlci5wb3N0KCcvYXBpL3NpZ251cCcsIChyZXEsIHJlcykgPT4ge1xuICBjb25zdCB7IGVtYWlsLCBwYXNzd29yZCB9ID0gcmVxLmJvZHk7XG4gIGlmICghZW1haWwgfHwgIXBhc3N3b3JkKSB7XG4gICAgcmV0dXJuIHJlcy5zdGF0dXMoNTAwKS5qc29uKHtcbiAgICAgIGVycm9yOiAnUHJvdmlkZSBhbiBlbWFpbCBhbmQgcGFzc3dvcmQgdG8gcmVnaXN0ZXInXG4gICAgfSk7XG4gIH1cbiAgY29uc3QgZXhpc3RzID0gZGJcbiAgICAuZ2V0KCd1c2VycycpXG4gICAgLmZpbmQoeyBlbWFpbDogZW1haWwgfSlcbiAgICAudmFsdWUoKTtcbiAgaWYgKGV4aXN0cykge1xuICAgIHJldHVybiByZXMuc3RhdHVzKDUwMCkuanNvbih7XG4gICAgICBlcnJvcjogYEVtYWlsICR7ZW1haWx9IGFscmVhZHkgcmVnaXN0ZXJlZCFgXG4gICAgfSk7XG4gIH1cbiAgdHJ5IHtcbiAgICBjb25zdCBoYXNoID0gYmNyeXB0Lmhhc2hTeW5jKHBhc3N3b3JkLCBiY3J5cHQuZ2VuU2FsdFN5bmMoMTApKTtcbiAgICAvLyBDcmVhciB1c3VhcmlvXG4gICAgZGIuZ2V0KCd1c2VycycpXG4gICAgICAucHVzaCh7XG4gICAgICAgIGVtYWlsOiBlbWFpbCxcbiAgICAgICAgcGFzc3dvcmQ6IGhhc2gsXG4gICAgICAgIGlzVmVyaWZpZWQ6IGZhbHNlXG4gICAgICB9KVxuICAgICAgLndyaXRlKCk7XG4gICAgLy8gQ3JlYXIgdG9rZW4gcGFyYSB2ZXJpZmljYWNpb25cbiAgICBjb25zdCB0b2tlbiA9IGNyeXB0byh7IGxlbmd0aDogMjAsIHR5cGU6ICd1cmwtc2FmZScgfSk7XG4gICAgZGIuZ2V0KCd0b2tlbnMnKVxuICAgICAgLnB1c2goe1xuICAgICAgICBlbWFpbDogZW1haWwsXG4gICAgICAgIHRva2VuOiB0b2tlblxuICAgICAgfSlcbiAgICAgIC53cml0ZSgpO1xuICAgIG1haWxTZW5kZXIoXG4gICAgICB7XG4gICAgICAgIHRvOiBlbWFpbCxcbiAgICAgICAgdGV4dDogYE5hdmlnYXRlIHRoaXMgbGluayAke2RvbWFpbn0vYXBpL3ZlcmlmeS8ke3Rva2VufS8ke2VtYWlsfSB0byBhY3RpdmF0ZSB5b3VyIGFjY291bnQuYFxuICAgICAgfSxcbiAgICAgIChlcnIsIHJlcykgPT4ge1xuICAgICAgICBjb25zb2xlLmxvZyh7IG1haWxTZW5kOiB7IGVyciwgcmVzIH0gfSk7XG4gICAgICB9XG4gICAgKTtcbiAgICByZXR1cm4gcmVzLnN0YXR1cygyMDApLmpzb24oe1xuICAgICAgb2s6IGBVc2VyIHJlZ2lzdGVyZWQuIFxuT3BlbiB5b3VyIGluYm94IGFuZCBhY3RpdmF0ZSB5b3VyIGFjY291bnQgXG53aXRoIHRoZSBlbWFpbCB3ZSd2ZSBqdXN0IHNlbnQgdG8geW91IWBcbiAgICB9KTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgY29uc29sZS5sb2coeyBlcnIgfSk7XG4gICAgcmV0dXJuIHJlcy5zdGF0dXMoNTAwKS5qc29uKHtcbiAgICAgIGVycm9yOiBlcnJcbiAgICB9KTtcbiAgfVxufSk7XG5cbnNlcnZlci5nZXQoJy9hcGkvdmVyaWZ5Lzp0b2tlbi86ZW1haWwnLCAocmVxLCByZXMpID0+IHtcbiAgY29uc3QgeyB0b2tlbiwgZW1haWwgfSA9IHJlcS5wYXJhbXM7XG4gIGNvbnN0IHVzZXIgPSBkYlxuICAgIC5nZXQoJ3VzZXJzJylcbiAgICAuZmluZCh7IGVtYWlsOiBlbWFpbCB9KVxuICAgIC52YWx1ZSgpO1xuXG4gIGlmICh1c2VyKSB7XG4gICAgaWYgKHVzZXIuaXNWZXJpZmllZCkge1xuICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoMjAyKS5qc29uKHsgb2s6ICdFbWFpbCBBbHJlYWR5IFZlcmlmaWVkJyB9KTtcbiAgICB9IGVsc2Uge1xuICAgICAgY29uc3QgZm91bmRUb2tlbiA9IGRiXG4gICAgICAgIC5nZXQoJ3Rva2VucycpXG4gICAgICAgIC5maW5kKHsgZW1haWw6IGVtYWlsLCB0b2tlbjogdG9rZW4gfSlcbiAgICAgICAgLnZhbHVlKCk7XG5cbiAgICAgIGlmIChmb3VuZFRva2VuKSB7XG4gICAgICAgIGRiLmdldCgndXNlcnMnKVxuICAgICAgICAgIC5maW5kKHsgZW1haWw6IGVtYWlsIH0pXG4gICAgICAgICAgLmFzc2lnbih7IGlzVmVyaWZpZWQ6IHRydWUgfSlcbiAgICAgICAgICAud3JpdGUoKTtcbiAgICAgICAgZGIuZ2V0KCd0b2tlbnMnKVxuICAgICAgICAgIC5yZW1vdmUoeyBlbWFpbDogZW1haWwsIHRva2VuOiB0b2tlbiB9KVxuICAgICAgICAgIC53cml0ZSgpO1xuICAgICAgICByZXR1cm4gcmVzLnJlZGlyZWN0KDMwMSwgYCR7ZG9tYWlufT91PSR7ZW1haWx9JnZlcmlmaWVkPTFgKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwNCkuanNvbih7IGVycm9yOiAnVG9rZW4gZXhwaXJlZCcgfSk7XG4gICAgICB9XG4gICAgfVxuICB9IGVsc2Uge1xuICAgIHJldHVybiByZXMuc3RhdHVzKDQwNCkuanNvbih7IGVycm9yOiAnRW1haWwgbm90IGZvdW5kJyB9KTtcbiAgfVxufSk7XG5cbnNlcnZlci5wb3N0KCcvYXBpL2xvZ2luJywgKHJlcSwgcmVzKSA9PiB7XG4gIGNvbnN0IHsgZW1haWwsIHBhc3N3b3JkIH0gPSByZXEuYm9keTtcbiAgY29uc3QgdXNlciA9IGRiXG4gICAgLmdldCgndXNlcnMnKVxuICAgIC5maW5kKHsgZW1haWw6IGVtYWlsIH0pXG4gICAgLnZhbHVlKCk7XG5cbiAgaWYgKHVzZXIpIHtcbiAgICBpZiAoIXVzZXIuaXNWZXJpZmllZCkge1xuICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAxKS5qc29uKHtcbiAgICAgICAgZXJyb3I6ICdVbmF1dGhvcml6ZWQgYWNjZXNzLiBBY2NvdW50IHdhcyBub3QgdmVyaWZpZWQuJ1xuICAgICAgfSk7XG4gICAgfVxuICAgIHRyeSB7XG4gICAgICBjb25zdCByZXN1bHQgPSBiY3J5cHQuY29tcGFyZVN5bmMocGFzc3dvcmQsIHVzZXIucGFzc3dvcmQpO1xuICAgICAgaWYgKHJlc3VsdCkge1xuICAgICAgICBjb25zdCBKV1RUb2tlbiA9IGp3dC5zaWduKFxuICAgICAgICAgIHtcbiAgICAgICAgICAgIGVtYWlsOiB1c2VyLmVtYWlsXG4gICAgICAgICAgfSxcbiAgICAgICAgICBqd3RTZWNyZXRLZXksXG4gICAgICAgICAge1xuICAgICAgICAgICAgZXhwaXJlc0luOiAnMmgnXG4gICAgICAgICAgfVxuICAgICAgICApO1xuICAgICAgICByZXR1cm4gcmVzLnN0YXR1cygyMDApLmpzb24oe1xuICAgICAgICAgIGp3dDogSldUVG9rZW5cbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDEpLmpzb24oe1xuICAgICAgICBlcnJvcjogJ1VuYXV0aG9yaXplZCBhY2Nlc3MnXG4gICAgICB9KTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIHJlcy5zdGF0dXMoNDAxKS5qc29uKHtcbiAgICAgICAgZXJyb3I6ICdVbmF1dGhvcml6ZWQgYWNjZXNzJ1xuICAgICAgfSk7XG4gICAgfVxuICB9IGVsc2Uge1xuICAgIHJlcy5zdGF0dXMoNTAwKS5qc29uKHtcbiAgICAgIGVycm9yOiAnVXNlciBvciBwYXNzd29yZCB3cm9uZydcbiAgICB9KTtcbiAgfVxufSk7XG5cbi8vIFRvZGFzIGxhcyBydXRhcyBhIHBhcnRpciBkZSBlc3RlIHB1bnRvXG4vLyBlc3RhbiBwcm90ZWdpZGFzIVxuc2VydmVyLnVzZSgocmVxLCByZXMsIG5leHQpID0+IHtcbiAgaWYgKHJlcS51c2VyKSB7XG4gICAgLy8gc2kgZWwgdXN1YXJpbyBoYSBzaWRvIHZhbGlkYWRvLCBjb250aW51YXJcbiAgICBuZXh0KCk7XG4gIH0gZWxzZSB7XG4gICAgLy8gTm8gaGF5IHVzZXIsIG5vIGhheSB0b2tlbiFcbiAgICByZXMuc3RhdHVzKDUwMCkuanNvbih7IGVycm9yOiAnVW5hdXRob3JpemVkIGFjY2VzcycgfSk7XG4gIH1cbn0pO1xuXG5zZXJ2ZXIuZ2V0KCcvYXBpL2xpc3QvOmxvY2FsZScsIGFzeW5jIChyZXEsIHJlcykgPT4ge1xuICBjb25zdCBwYXRjaCA9IGF3YWl0IHJlYWRMb2NhbGVQYXRjaCgpO1xuICBjb25zdCB7IGxvY2FsZSB9ID0gcmVxLnBhcmFtcztcbiAgdmFyIHNvbmdzID0gRm9sZGVyU29uZ3MuZ2V0U29uZ3NNZXRhKGxvY2FsZSwgcGF0Y2gpO1xuICByZXMuanNvbihzb25ncyk7XG59KTtcblxuc2VydmVyLmdldCgnL2FwaS9zb25nLzprZXkvOmxvY2FsZScsIGFzeW5jIChyZXEsIHJlcykgPT4ge1xuICBjb25zdCBwYXRjaCA9IGF3YWl0IHJlYWRMb2NhbGVQYXRjaCgpO1xuICBjb25zdCB7IGtleSwgbG9jYWxlIH0gPSByZXEucGFyYW1zO1xuICBjb25zdCBzb25ncyA9IEZvbGRlclNvbmdzLmdldFNvbmdzTWV0YShsb2NhbGUsIHBhdGNoKTtcbiAgY29uc3Qgc29uZyA9IHNvbmdzLmZpbmQocyA9PiBzLmtleSA9PT0ga2V5KTtcbiAgaWYgKHNvbmcpIHtcbiAgICBhd2FpdCBGb2xkZXJTb25ncy5sb2FkU2luZ2xlU29uZyhsb2NhbGUsIHNvbmcsIHBhdGNoKTtcbiAgICByZXMuanNvbihzb25nKTtcbiAgfVxufSk7XG5cbnNlcnZlci5kZWxldGUoJy9hcGkvc29uZy86a2V5Lzpsb2NhbGUnLCBhc3luYyAocmVxLCByZXMpID0+IHtcbiAgdmFyIHBhdGNoT2JqID0gYXdhaXQgcmVhZExvY2FsZVBhdGNoKCk7XG4gIGNvbnN0IHsga2V5LCBsb2NhbGUgfSA9IHJlcS5wYXJhbXM7XG5cbiAgaWYgKCFwYXRjaE9iaikgcGF0Y2hPYmogPSB7fTtcbiAgZGVsZXRlIHBhdGNoT2JqW2tleV1bbG9jYWxlXTtcblxuICBhd2FpdCBzYXZlTG9jYWxlUGF0Y2gocGF0Y2hPYmopO1xuICBjb25zb2xlLmxvZygnQm9ycmFkbyBwYXRjaCcsIGtleSk7XG4gIHJlcy5qc29uKHsgb2s6IHRydWUgfSk7XG59KTtcblxuc2VydmVyLnBvc3QoJy9hcGkvc29uZy86a2V5Lzpsb2NhbGUnLCBhc3luYyAocmVxLCByZXMpID0+IHtcbiAgdmFyIHBhdGNoT2JqID0gYXdhaXQgcmVhZExvY2FsZVBhdGNoKCk7XG4gIGNvbnN0IHsga2V5LCBsb2NhbGUgfSA9IHJlcS5wYXJhbXM7XG5cbiAgY29uc3QgcGF0Y2g6IFNvbmdQYXRjaERhdGEgPSByZXEuYm9keTtcbiAgaWYgKCFwYXRjaE9iaikgcGF0Y2hPYmogPSB7fTtcblxuICBpZiAocGF0Y2gucmVuYW1lKSB7XG4gICAgcGF0Y2gucmVuYW1lID0gcGF0Y2gucmVuYW1lLnRyaW0oKTtcbiAgfVxuXG4gIHBhdGNoLmF1dGhvciA9IHJlcS51c2VyLmVtYWlsO1xuXG4gIGNvbnN0IGxvY2FsZVBhdGNoOiBTb25nUGF0Y2ggPSB7XG4gICAgW2xvY2FsZV06IHBhdGNoXG4gIH07XG4gIGlmICghcGF0Y2hPYmpba2V5XSkge1xuICAgIHBhdGNoT2JqW2tleV0gPSB7fTtcbiAgfVxuICB2YXIgdXBkYXRlZFBhdGNoID0gbWVyZ2UocGF0Y2hPYmpba2V5XSwgbG9jYWxlUGF0Y2gpO1xuICBwYXRjaE9ialtrZXldID0gdXBkYXRlZFBhdGNoO1xuXG4gIGF3YWl0IHNhdmVMb2NhbGVQYXRjaChwYXRjaE9iaik7XG4gIGNvbnNvbGUubG9nKCdHdWFyZGFkbyBwYXRjaCcsIGtleSwgdXBkYXRlZFBhdGNoKTtcbiAgcmVzLmpzb24oeyBvazogdHJ1ZSB9KTtcbn0pO1xuXG4vLyBTdGFydCBzZXJ2ZXJcbnJlcXVpcmUoJ2h0dHAnKVxuICAuY3JlYXRlU2VydmVyKHNlcnZlcilcbiAgLmxpc3Rlbihwcm9jZXNzLmVudi5QT1JULCBmdW5jdGlvbigpIHtcbiAgICBjb25zb2xlLmxvZygnSHR0cCBvbiBwb3J0JywgcHJvY2Vzcy5lbnYuUE9SVCk7XG4gIH0pO1xuIl19